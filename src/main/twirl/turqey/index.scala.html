@import turqey.entity._
@import turqey.servlet._
@import turqey.controller._
@import turqey.utils.Json

@(articleIds: Seq[Seq[scala.Long]], stockIds: Seq[Seq[scala.Long]], ownIds: Seq[Seq[scala.Long]], articles: Seq[Article.ArticleForList])
<html>
  @css()
  <body>
    <script type="text/javascript" src="@assets/vender/js/materialize.js"></script>
    <script type="text/javascript" src="@assets/vender/js/knockout.js"></script>
    @topnav()
    <main>
    <div class="container" id="container">
      <p>CSV知識を共有しよう。</p>
      <p>
        <a href="@root/article/edit" class="waves-effect waves-light btn"><i class="material-icons right">edit</i>新規作成</a>
      </p>
      <div class="row">
        <div class="col s12">
          <ul class="tabs">
            <li class="tab col"><a class="waves-effect active" data-bind="click: showWhole">全ての投稿</a></li>
            <li class="tab col"><a class="waves-effect" data-bind="click: showStock">ストック</a></li>
            <li class="tab col"><a class="waves-effect" data-bind="click: showOwn">自分の投稿</a></li>
          </ul>
        </div>
        <!-- ko foreach: tabs -->
          <div data-bind="visible: (name == $root.selectedTab())">
            <div class="col s12" data-bind="foreach: articles">
              <div class="card">
                <div class="card-content">
                  <span class="card-title">
                  <a class="collection-item waves-effect waves-light" data-bind="text: title, attr: { href: '@root/article/' + id }"></a>
                  </span>
                  <p>
                    <span data-bind="text: owner.name"></span>
                    <span data-bind="text: created"></span>
                  </p>
                  <p>
                    <div data-bind="foreach: tags ">
                      <div class="chip">
                        <a data-bind="text: name, attr: { href: '@root/tag/' + id }" ></a>
                      </div>
                    </div>
                  </p>
                </div>
              </div>
            </div>
            <button class="waves-effect waves-light btn" data-bind="visible: hasNext, click: append">もっと見る</button>
          </div>
        <!-- /ko -->
      </div>
    </div>
    </main>
  </body>
<script>

var ViewModel = function (){
  var self = this;
  
  var TabModel = function (name, ids){
    var self = this;
    
    self.name = name;
    self.ids = ko.observableArray(ids);
    self.articles = ko.observableArray([]);
    
    self.append = function() {
      $.post('@root/api/article/list', { ids: self.ids.shift() }, function (response){ self.articles(self.articles().concat(response)) } );
    };
    self.load = function() {
      if (!self.articles().length){ self.append(); }
    };
    self.hasNext = ko.pureComputed(function (){ return self.ids().length !== 0; });
  };
  
  self.allIds   = @{Html(Json.toJson( articleIds ))};
  self.stockIds = @{Html(Json.toJson( stockIds ))};
  self.ownIds   = @{Html(Json.toJson( ownIds ))};
  
  self.whole = new TabModel("whole", self.allIds),
  self.stock = new TabModel("stock", self.stockIds),
  self.own   = new TabModel("own",   self.ownIds)
  
  self.tabs = ko.observableArray([self.whole, self.stock, self.own]);
  
  self.selectedTab = ko.observable('whole');
  self.whole.load();
  
  self.showWhole = function (){ self.selectedTab("whole");self.whole.load(); };
  self.showStock = function (){ self.selectedTab("stock");self.stock.load(); };
  self.showOwn   = function (){ self.selectedTab("own");  self.own.load(); };
};


// Activates knockout.js
var vm = new ViewModel();
ko.applyBindings(vm, document.getElementById('container'));
</script>
</html>
