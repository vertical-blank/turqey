@import turqey.entity._
@import turqey.html._
@import turqey.view._
@import turqey.utils.Implicits._
@import turqey.controller._

@(article: Article, tags: Seq[Tag], comments: Seq[ArticleComment], stocked: Boolean, count: Long)
<html>
  @css()
  <body>
  <script type="text/javascript" src="@assets/vender/js/materialize.js"></script>
  <script type="text/javascript" src="@assets/vender/js/knockout.js"></script>
    @topnav {
    <div class="">
      <div class="container">
        <div class="row">
          <div class="col s8">
            <p>
              <span>@article.title</span>
            <p>
            <p>
              <span>@article.owner.get.name が @{article.created.toString("yyyy/MM/dd")} に投稿</span>
            </p>
            <p>
            @tags.map { tag =>
              <div class="chip">
                <a href="@TagController.root/@tag.id">@tag.name</a>
              </div>
            }
            </p>
            @if(article.editable){
            <p>
              <a href="@ArticleController.root/@article.id/edit" class="waves-effect waves-light btn"><i class="material-icons right">edit</i>編集</a>
            </p>
            }
          </div>
          <div class="col s4 right-align" id="divStock">
            <p>
              <span data-bind="text: count"></span> ストック
            </p>
            @if(SessionHolder.user.get.id != article.ownerId) {
            <p>
              <button type="button"
                class="waves-effect waves-light btn"
                style="display: none"
                data-bind="click: toggleStock, visible: stocked"><i class="material-icons right">cancel</i>解除</button>
              <button type="button"
                class="waves-effect waves-light btn"
                style="display: none"
                data-bind="click: toggleStock, visible: !stocked()"><i class="material-icons right">folder</i>ストック</button>
            <p>
            }
          </div>
        </div>
      </div>
    </div>
    } 
    <div class="container" id="main_content">
      <div>@Html(Markdown.html(article.content))</div>
      <hr>
      <div>
        <div class="row">
          <div class="col s10">
            <i class="material-icons">comment</i>コメント
          </div>
        </div>
        <div class="row">
          @comments.zipWithIndex.map { case (comment, idx) =>
          <div class="card">
            @if(comment.editable){
            <div class="fixed-action-btn horizontal" style="position: absolute; display: inline-block; right: 24px; top: 10px;">
              @*
              <a class="btn-floating btn">
                <i class="small material-icons">edit</i>
              </a>
              *@
              <form action="@ArticleController.root/@article.id/comment/@comment.id/delete" method="post" style="display: inline;">
              <button class="btn-floating btn red">
                <i class="small material-icons">delete</i>
              </button>
              </form>
            </div>
            }
            <div class="card-content">
            <span class="card-title">@comment.user.get.name @comment.created.toString("yyyy/MM/dd")</span>
              @Html(Markdown.html(comment.content))
            </div>
          </div>
          }
        </div>
        <div class="row">
          <form action="@ArticleController.root/@article.id/comment" method="post" id="formComment">
            <div class="input-field col s12">
              <textarea name="comment" class="materialize-textarea"
                placeholder="Markdown" id="input_comment"
                data-bind="textInput: comment"></textarea>
              <label>Comment</label>
            </div>
            <div class="input-field col s12">
              <button type="submit" class="waves-effect waves-light btn"
                data-bind="enable: commentable"><i class="material-icons right">send</i>コメント</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </body>
<script>
var ViewModel = function (initialState){
  var self = this;
  self.stocked = ko.observable(initialState);
  self.toggleStock = function(obj, e){
    $.post('@ArticleController.root/@article.id/stock', function(dat){
      self.stocked(!self.stocked());
      self.count(dat.count);
    });
  };
  self.count = ko.observable(@count);
};

var CommentViewModel = function (){
  var self = this;
  self.comment = ko.observable('');
  self.commentable = ko.pureComputed( function (){ return self.comment().length != 0; } );
};
// Activate knockout.js
var vm = new ViewModel(@{Html(stocked.toString)});
var commentVm = new CommentViewModel();
ko.applyBindings(vm, document.getElementById('divStock'));
ko.applyBindings(commentVm, document.getElementById('formComment'));
</script>
</html>

