@import turqey.entity._
@import turqey.html._
@import turqey.controller._
@import turqey.utils.Implicits._
@import turqey.utils.Json

@(article: Option[Article], tags: Seq[Tag])
<html>
  @css()
  <style>
    html, body { height:100%; margin:0; }
  </style>
  <body>
  <script type="text/javascript" src="@assets/vender/js/materialize.js"></script>
  <link href="@assets/vender/css/knockout.autocomplete.css" rel="stylesheet" />

  <script type="text/javascript" src="@assets/vender/ace/ace.js"></script>
  <script type="text/javascript" src="@assets/vender/js/diffDOM.js"></script>
  <script type="text/javascript" src="@assets/vender/js/jquery.scrollTo.min.js"></script>
  <script type="text/javascript" src="@assets/vender/js/CsvToMarkdown.js"></script>

  @topnav()
  <script type="text/javascript" src="@assets/vender/js/knockout.autocomplete.js"></script>
  <script type="text/javascript" src="@assets/vender/js/knockout-ace.js"></script>
    <main>
    <form action="@root/article/@article.map(_.id)" method="post" class="col s12" id="form">
        <div class="row">
          <div class="input-field col s8">
            <input type="text" name="title" 
              id="input_title" length="120"
              data-bind="textInput: title">
            <label>Title</label>
            </input>
          </div>
          <div class="input-field col s4 right-align">
            <button type="submit" class="waves-effect waves-light btn"
              data-bind="enable: postable, click: beforeSubmit" disabled><i class="material-icons right">save</i>保存</button>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s3">
            <i class="material-icons prefix">search</i>
            <input type="text" id="find_tag" placeholder="検索"
              data-bind="event: {keypress: onEnter},
                         textInput: tagText,
                         autocomplete: {
                           data    : allTags,
                           format  : formatTagItem,
                           onSelect: select,
                           visible : autoCompleteVisible
                         }">
            <label>Tag</label>
            </input>
          </div>
          <div class="input-field col s9">
          <!-- ko foreach: tags -->
            <div class="chip">
              <span data-bind="text: name"></span>
              <input type="hidden" name="tagIds"   data-bind="value: id">
              <input type="hidden" name="tagNames" data-bind="value: name">
              <i class="material-icons" data-bind="click: $root.remove">close</i>
            </div>
          <!-- /ko -->
          </div>
        </div>
        
        <div style="position: absolute; top: 230px; bottom: 40px; width: 100%; background-color: white; z-index: 2;" data-bind="style: {top: editorTop}">
          <div style="height: 36px; width: 100%;border-top: 1px solid #D0D0D0; border-bottom: 1px solid #D0D0D0;">
            <a class="dropdown-button waves-effect waves-grey btn-flat" style="padding: 0 1rem;" data-activates="langs" data-constrainwidth="false"><i class="small material-icons">code</i></a>
            <a class="waves-effect waves-grey btn-flat" style="padding: 0 1rem;" data-bind="click: insertLink"><i class="small material-icons">link</i></a>
            <a class="waves-effect waves-grey btn-flat" style="padding: 0 1rem;" data-bind="click: insertPhoto"><i class="small material-icons">insert_photo</i></a>
            <a class="waves-effect waves-grey btn-flat modal-trigger" href="#modal1" style="padding: 0 1rem;"><i class="small material-icons">grid_on</i></a>
            <div class="right">
              <a class="waves-effect waves-grey btn-flat" style="padding: 0 1rem;" data-bind="click: shiftToPreview, css: {disabled: unshiftableToPreview}"><i class="small material-icons">chevron_left</i></a>
              <a class="waves-effect waves-grey btn-flat" style="padding: 0 1rem;" data-bind="click: shiftToEditor, css: {disabled: unshiftableToEditor}"><i class="small material-icons">chevron_right</i></a>
              <a class="waves-effect waves-grey btn-flat" style="padding: 0 1rem;" data-bind="click: fullscreen, visible: !isFullscreen()"><i class="small material-icons">fullscreen</i></a>
              <a class="waves-effect waves-grey btn-flat" style="padding: 0 1rem;" data-bind="click: exitFullscreen, visible: isFullscreen"><i class="small material-icons">fullscreen_exit</i></a>
            </div>
          </div>
          <div style="float: left; height: 100%; border-right: 1px solid #E0E0E0;" data-bind="style: {width: editorWidth}, visible: !(unshiftableToPreview())">
            <div class="editor"
              style="height: 100%; width: 100%;"
              id="input_content"
              data-bind="ace: content,
                          aceOptions: {
                            mode: 'markdown',
                            theme: 'eclipse',
                            fontSize: '14px',
                            change: changeContent
                          }"></div>
            <textarea name="content" data-bind="value: content" style="display: none;"></textarea>
            <label for="input_content" class="active" ></label>
          </div>
          <div style="overflow: auto; height: 100%;" data-bind="style: {width: previewWidth}, visible: !(unshiftableToEditor())" id="prev_container">
            <div>
              <div id="preview" class="markdown" data-bind="html: marked"></div>
            </div>
          </div>
        </div>
    <ul id="langs" class="dropdown-content" style="max-height: 300px; overflow-x: hidden;">
      <!-- ko foreach: langs -->
        <li><a data-bind="text: name, click: $root.insertLang" ></a></li>
      <!-- /ko -->
    </ul>
    <div id="modal1" class="modal modal-fixed-footer">
      <div class="modal-content">
        <h4>Table</h4>
        <p><textarea id="textarea1" class="materialize-textarea" data-bind="value: contentCsv"></textarea></p>
        <p>
          <input type="checkbox" class="filled-in" id="first_header" data-bind="checked: setFirstLineAsHeader"><label for="first_header">先頭行をヘッダとする</label>
          <input name="sep_char" type="radio" id="sep_comma" value="c" data-bind="checked: sepChar" />
          <label for="sep_comma">カンマ</label>
          <input name="sep_char" type="radio" id="sep_tab" value="t" data-bind="checked: sepChar" />
          <label for="sep_tab">タブ</label>
        </p>
      </div>
      <div class="modal-footer">
        <a href="#!" class="modal-action modal-close waves-effect waves-grey btn-flat"
        data-bind="click: insertTable">実行</a>
      </div>
    </div>
    </form>
    </main>
  </body>

<script>
var allTags = @{Html(Json.toJson(Tag.findAll()))};
var ViewModel = function (initialTags){
  var self = this;
  self.tags = ko.observableArray(initialTags);
  self.remove = function (obj, e){
    self.tags.remove(obj);
  };
  self.add = function(obj, e){
    e && e.preventDefault();
    if (!self.tagText().trim()){ return };
    self.tags.push({id: self.tagId(), name: self.tagText()});
    self.tagText('');
    self.tagId('');
  };
  self.onEnter = function(obj, e){
    e.keyCode === 13 && self.add(obj, e);
    return true;
  };
  self.tagText = ko.observable('');
  self.tagId = ko.observable('');
  self.allTags = allTags;
  self.formatTagItem = function(i) { return i.name; };
  self.select = function(i) {
    if (self.autoCompleteVisible()){
      self.tagText(self.formatTagItem(i));
      self.tagId(i.id);
    }
    self.add();
  };
  self.autoCompleteVisible = ko.observable(false);

  var delay = (function(){
    var timer = 0;
    return function(callback, ms){
      clearTimeout (timer);
      timer = setTimeout(callback, ms);
    };
  })();
  self.marked = ko.observable("");
  self.changeContent = function(){
    delay(function(){
      $.post(
        '@root/api/markdown',
        { content: self.getEditor().getValue() },
        function(response) {
          var prev = $($('#preview').parent().html())[0];
          
          self.marked(response);
          
          Prism.highlightAll();
          
          var current = $('#preview')[0];
          
          var dd = new diffDOM();
          var diffs = dd.diff(prev, current);

 
          //setTimeout(function() {
            var elem;
            while (true){
              if (diffs.length === 0){ break; }
              
              var diff = diffs.shift();
              
              if (diff.action === "modifyAttribute" && diff.newValue.trim() === diff.oldValue.trim() ){
                continue;
              }
              
              var elem = $(dd.getFromRoute(current, diff.route));
              if (elem.length === 0){
                continue;
              }
              
              while (elem.offset().left === 0){
                elem = elem.parent();
                if (elem.attr('id') === 'preview'){
                  break;
                }
              }
              if (elem.attr('id') === 'preview'){
                continue;
              }
              
              $('#prev_container').scrollTo(elem);
              
              break;
            }
          //}, 200);
          
        }
    )}, 800);
  };
  
  self.langs = ko.observableArray([
    {name: 'bash'},
    {name: 'batch'},
    {name: 'csharp'},
    {name: 'css'},
    {name: 'd'},
    {name: 'git'},
    {name: 'go'},
    {name: 'groovy'},
    {name: 'haskell'},
    {name: 'java'},
    {name: 'javascript'},
    {name: 'kotlin'},
    {name: 'latex'},
    {name: 'markdown'},
    {name: 'markup'},
    {name: 'ocaml'},
    {name: 'perl'},
    {name: 'php'},
    {name: 'powershell'},
    {name: 'python'},
    {name: 'ruby'},
    {name: 'scala'},
    {name: 'sql'},
    {name: 'swift'},
    {name: 'typescript'},
    {name: 'yaml'}
  ]);
  
  self.insertLang = function(lang){
    (function(editor){
      var selection = editor.getSelection();
      var row = selection.getCursor().row;
      editor.getSession().insert({ row: row + 1, column: 0 }, "```" + lang.name + "\r\nInsert_Code_Here\r\n```");
      selection.setSelectionRange({start:{row: row + 1, column: 0}, end:{row: row + 1, column:20}});
    })(self.getEditor())
  };
  
  self.editor = null;
  self.getEditor = function(){
    if (!self.editor) {
      self.editor = ace.edit("input_content");
    }
    return self.editor;
  };
  
  self.insertLink  = function(){
    var editor = self.getEditor();
    var range = editor.selection.getRange();
    
    if (range.isEmpty()) {
      editor.getSession().insert(editor.getSelection().getCursor(), "[text](url)");
    }
    else {
      var lines = editor.getSession().doc.getLinesForRange(range);
      
      var queries = [];
      for (var i in lines){
        queries.push("select * from html where url = '" + lines[i] + "' and (xpath='/html/head')");
      }
      
      var query = 'select * from yql.query.multi where queries = \"' + queries.join(";") + '\"';
      
      $.get("https://query.yahooapis.com/v1/public/yql?format=json&q=" + encodeURIComponent(query),
        function(response) {
          var replaceTexts = [];
          
          var results = response.query.results.results;
          if (!$.isArray(results)){
            results = [results];
          }
          
          for (var i in results){
            var result = results[i];
            var head = result ? result.head:null;
            replaceTexts.push( head ? "[" + head.title + "](" + lines[i] + ")": lines[i] );
          }
          
          editor.getSession().replace(editor.selection.getRange(), replaceTexts.join("\r\n"));
        }
      );
    }
      
  };
  self.insertPhoto = function(){
    var editor = self.getEditor();
    var range = editor.selection.getRange();
    
    if (range.isEmpty()) {
      editor.getSession().insert(editor.getSelection().getCursor(), "![alt_text](image_url)");
    }
    else {
      var selectedText = editor.getSession().doc.getTextRange(editor.selection.getRange());
      editor.getSession().replace(editor.selection.getRange(), "![alt_text](" + selectedText + ")");
    }
  };
  self.insertTable = function(){ 
    (function(editor){
      editor.getSession().insert(editor.getSelection().getCursor(), csvToMarkdown(self.contentCsv(), {"c": ",", "t":"\t"}[self.sepChar()], self.setFirstLineAsHeader()))
    })(self.getEditor());
    self.contentCsv("");
  };
  
  // 0: editorOnly, 1: half, 2: previewOnly
  self.toggleState = ko.observable(1);
  self.shiftToEditor = function() { var state = self.toggleState(); if (state !== 0){ self.toggleState(--state) }  };
  self.shiftToPreview = function() { var state = self.toggleState(); if (state !== 2){ self.toggleState(++state) }  };
  self.unshiftableToEditor = ko.pureComputed( function(){ return self.toggleState() === 0; } );
  self.unshiftableToPreview = ko.pureComputed( function(){ return self.toggleState() === 2; } );
  self.editorWidth = ko.pureComputed( function(){ return ["100%", "50%", "0%"][self.toggleState()]; } );
  self.previewWidth = ko.pureComputed( function(){ return ["0%", "50%", "100%"][self.toggleState()]; } );
  self.editorVisible = ko.pureComputed( function(){ return ["100%", "50%", "0%"][self.toggleState()]; } );
  self.previewVisible = ko.pureComputed( function(){ return ["0%", "50%", "100%"][self.toggleState()]; } );

  self.isFullscreen = ko.observable(false);
  self.fullscreen = function(){ self.isFullscreen(true);self.getEditor().resize(); };
  self.exitFullscreen = function(){ self.isFullscreen(false);self.getEditor().resize(); };
  self.editorTop = ko.pureComputed(function(){ return self.isFullscreen()? "0px": "230px"; });

  self.title = ko.observable(@{Html(Json.toJson( article.map(_.title).getOrElse("") ))});
  self.content = ko.observable(@{Html(Json.toJson( article.map( x => clobToString(x.content)).getOrElse("") ))});
  self.contentCsv = ko.observable("");
  self.setFirstLineAsHeader = ko.observable(true);
  self.sepChar = ko.observable("c");
  self.postable = ko.pureComputed( function (){ return !(!self.content() || self.content().length == 0 || !self.title() || self.title().length == 0); } );
  self.beforeSubmit = function (){ $(window).unbind("beforeunload"); return true; };
};

// Activates knockout.js
var vm = new ViewModel(@{Html(Json.toJson(tags))});
ko.applyBindings(vm, document.getElementById('form'));

$('.modal-trigger').leanModal();
$(window).bind("beforeunload", function() {
  return "保存せずに移動しますか？";
});
</script>
</html>

