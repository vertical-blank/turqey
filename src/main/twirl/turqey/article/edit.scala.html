@import turqey.entity._
@import turqey.html._
@import turqey.controller._
@import turqey.utils.Implicits._
@import turqey.utils.Json

@(article: Option[Article], tags: Seq[Tag])
<html>
  @css()
  <body>
  <script type="text/javascript" src="@assets/vender/js/materialize.js"></script>
  <script type="text/javascript" src="@assets/vender/js/jquery.js"></script>
  <script type="text/javascript" src="@assets/vender/js/knockout.js"></script>
  <script type="text/javascript" src="@assets/vender/js/knockout.autocomplete.js"></script>
  <link href="@assets/vender/css/knockout.autocomplete.css" rel="stylesheet" />

  <script type="text/javascript" src="@assets/vender/ace/ace.js"></script>
  <script type="text/javascript" src="@assets/vender/js/knockout-ace.js"></script>

  @*
  <link rel="stylesheet" href="@assets/vender/css/uikit.min.css" />
  <script src="@assets/vender/js/uikit.min.js"></script>

  <!-- Codemirror and marked dependencies -->
  <link rel="stylesheet" href="@assets/vender/css/codemirror.css">
  <script src="@assets/vender/js/codemirror.js"></script>
  <script src="@assets/vender/js/markdown.js"></script>
  <script src="@assets/vender/js/overlay.js"></script>
  <script src="@assets/vender/js/xml.js"></script>
  <script src="@assets/vender/js/gfm.js"></script>
  <script src="@assets/vender/js/marked.min.js"></script>

  <!-- HTML editor CSS and JavaScript -->
  <link rel="stylesheet" href="@assets/vender/css/htmleditor.min.css">
  <script src="@assets/vender/js/htmleditor.min.js"></script>
  *@

  @topnav()
    <main>
    <div class="container">
      <form action="@root/article/@article.map(_.id)" method="post" class="col s12" id="form">
        <div class="row">
          <div class="input-field col s8">
            <input type="text" name="title" 
              id="input_title" length="120"
              data-bind="textInput: title">
            <label>Title</label>
            </input>
          </div>
          <div class="input-field col s4 right-align">
            <button type="submit" class="waves-effect waves-light btn"
              data-bind="enable: postable" disabled><i class="material-icons right">save</i>保存</button>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s3">
            <i class="material-icons prefix">search</i>
            <input type="text" id="find_tag" placeholder="検索"
              data-bind="event: {keypress: onEnter},
                         inputText: tagText,
                         autocomplete: {
                           data    : allTags,
                           format  : formatTagItem,
                           onSelect: select
                         }">
            <label>Tag</label>
            </input>
          </div>
          <div class="input-field col s9">
          <!-- ko foreach: tags -->
            <div class="chip">
              <span data-bind="text: name"></span>
              <input type="hidden" name="tagIds"   data-bind="value: id">
              <input type="hidden" name="tagNames" data-bind="value: name">
              <i class="material-icons" data-bind="click: $root.remove">close</i>
            </div>
          <!-- /ko -->
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12" >
            <div class="card" style="height: 500px;">
              <div style="float: left; width: 50%; height: 100%;">
                <div style="height: 36px; width: 100%;">
                  <a class="waves-effect waves-grey btn-flat" style="padding: 0 1rem;"><i class="small material-icons">code</i></a>
                  <a class="waves-effect waves-grey btn-flat" style="padding: 0 1rem;"><i class="small material-icons">link</i></a>
                  <a class="waves-effect waves-grey btn-flat" style="padding: 0 1rem;"><i class="small material-icons">border_all</i></a>
                  <a class="waves-effect waves-grey btn-flat" style="padding: 0 1rem;"><i class="small material-icons">format_list_bulleted</i></a>
                  <a class="waves-effect waves-grey btn-flat" style="padding: 0 1rem;"><i class="small material-icons">format_list_numbered</i></a>
                </div>
                <div class="editor"
                  style="height: 100%; width: 100%;"
                  id="input_content"
                  data-bind="ace: content,
                             aceOptions: {
                               mode: 'markdown',
                               theme: 'eclipse',
                               fontSize: '14px',
                               change: changeContent
                             }"></div>
                <textarea name="content"
                  data-bind="value: content, visible: false"></textarea>
                <label for="input_content" class="active" ></label>
              </div>
              <div>
                <div class="right-align" style="height: 36px; width: 100%;">
                  <a class="waves-effect waves-grey btn-flat" style="padding: 0 1rem;"><i class="small material-icons">fullscreen</i></a>
                </div>
                <div style="overflow: auto;">
                  <div id="preview" class="markdown" style="height: 100%;"
                    data-bind="html: marked"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
    </main>
  </body>

<script>
var allTags = @{Html(Json.toJson(Tag.findAll()))}
var ViewModel = function (initialTags){
  var self = this;
  self.tags = ko.observableArray(initialTags);
  self.remove = function (obj, e){
    self.tags.remove(obj);
  };
  self.add = function(obj, e){
    e && e.preventDefault();
    if (!self.tagText().trim()){ return };
    self.tags.push({id: self.tagId(), name: self.tagText()});
    self.tagText('');
    self.tagId('');
  };
  self.onEnter = function(obj, e){
    e.keyCode === 13 && self.add(obj, e);
    return true;
  };
  self.tagText = ko.observable('');
  self.tagId = ko.observable('');
  self.allTags = allTags;
  self.formatTagItem = function(i) { return i.name; };
  self.select = function(i) {
    self.tagText(self.formatTagItem(i));
    self.tagId(i.id);
    self.add(i);
  };

  var delay = (function(){
    var timer = 0;
    return function(callback, ms){
      clearTimeout (timer);
      timer = setTimeout(callback, ms);
    };
  })();
  self.marked = ko.observable("");
  self.changeContent = function(){
    delay(function(){
      $.post(
        '@root/api/markdown',
        {content: ace.edit("input_content").getValue() },
        function(response) {
          self.marked(response);
          Prism.highlightAll();
        }
    )}, 800);
  };
  self.title = ko.observable(@{Html(Json.toJson( article.map(_.title).getOrElse("") ))});
  self.content = ko.observable(@{Html(Json.toJson( article.map( x => clobToString(x.content)).getOrElse("") ))});
  self.postable = ko.pureComputed( function (){ return !(!self.content() || self.content().length == 0 || !self.title() || self.title().length == 0); } );
};

// Activates knockout.js
var vm = new ViewModel(@{Html(Json.toJson(tags))});
ko.applyBindings(vm, document.getElementById('form'));
</script>
</html>

