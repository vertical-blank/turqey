@import turqey.entity._
@import turqey.html._
@import turqey.utils.Implicits._
@import turqey.utils.Json

@(article: Option[Article], tags: Seq[Tag])
<html>
  @css()
  <body>
  <script type="text/javascript" src="@assets/vender/js/materialize.js"></script>
  <script type="text/javascript" src="@assets/vender/js/knockout.js"></script>
  <script type="text/javascript" src="/assets/vender/js/knockout.autocomplete.js"></script>
  <link href="/assets/vender/css/knockout.autocomplete.css" rel="stylesheet" />
    @topnav()
    <main>
    <div class="container">
      <form action="/article/@article.map(_.id)" method="post" class="col s12" id="form">
        <div class="row">
          <div class="input-field col s12">
            <input type="text" name="title" 
              id="input_title" length="120"
              data-bind="textInput: title">
            <label>Title</label>
            </input>
          </div>
          <div class="input-field col s3">
            <i class="material-icons prefix">search</i>
            <input type="text" id="find_tag" placeholder="検索"
              data-bind="event: {keypress: onEnter},
                         textInput: tagText,
                         autocomplete: {
                           data    : allTags,
                           format  : formatTagItem,
                           onSelect: select
                         }">
            <label>Tag</label>
            </input>
          </div>
          <div class="input-field col s9">
          <!-- ko foreach: tags -->
            <div class="chip">
              <span data-bind="text: name"></span>
              <input type="hidden" name="tagIds"   data-bind="value: id">
              <input type="hidden" name="tagNames" data-bind="value: name">
              <i class="material-icons" data-bind="click: $root.remove">close</i>
            </div>
          <!-- /ko -->
          </div>
          <div class="input-field col s12">
            <textarea name="content" class="materialize-textarea" 
              placeholder="Markdown" id="input_content"
              data-bind="textInput: content"></textarea>
            <label>Content</label>
          </div>
        </div>
        <button type="submit" class="waves-effect waves-light btn"
          data-bind="enable: postable" disabled><i class="material-icons right">check</i>保存</button>
      </form>
    </div>
    </main>
  </body>

<script>
var allTags = @{Html(Json.toJson(Tag.findAll()))}
var ViewModel = function (initialTags){
  var self = this;
  self.tags = ko.observableArray(initialTags);
  self.remove = function (obj, e){
    self.tags.remove(obj);
  };
  self.add = function(obj, e){
    e && e.preventDefault();
    if (!self.tagText().trim()){ return };
    self.tags.push({id: self.tagId(), name: self.tagText()});
    self.tagText('');
    self.tagId('');
  };
  self.onEnter = function(obj, e){
    e.keyCode === 13 && self.add(obj, e);
    return true;
  };
  self.tagText = ko.observable('');
  self.tagId = ko.observable('');
  self.allTags = allTags;
  self.formatTagItem = function(i) { return i.name; };
  self.select = function(i) {
    self.tagText(self.formatTagItem(i));
    self.tagId(i.id);
    self.add(i);
  };

  self.title = ko.observable(@{Html(Json.toJson(article.map(_.title)))});
  self.content = ko.observable(@{Html(Json.toJson(article.map( x => clobToString(x.content))))});
  self.postable = ko.pureComputed( function (){ return !(!self.content() || self.content().length == 0 || !self.title() || self.title().length == 0); } );
};

// Activates knockout.js
var vm = new ViewModel(@{Html(Json.toJson(tags))});
ko.applyBindings(vm, document.getElementById('form'));
</script>
</html>

