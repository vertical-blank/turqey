- import turqey.servlet.ServletContextHolder._
- import turqey.entity._
- import turqey.servlet._
- import turqey.utils.Implicits._
- import turqey.utils.Json

-@val u: Option[User]

script(type="text/javascript" src="#{assets}/vender/js/jquery.imgareaselect.min.js")
link(href="#{assets}/vender/css/imgareaselect-animated.css" rel="stylesheet")
script(type="text/javascript" src="#{assets}/vender/js/pica.min.js")
div.container(style="margin-top: 10px;")
  div.row
    div.col.s4
      div()
        a#modal-trigger(href="#modal1")
          img#image(src="#{root}/user/#{u.map(_.id)}/image" style="width: 200px;height: 200px;")
    div.col.s8
      form.col.s12#form(action="#{root}/user/#{u.map(_.id)}" method="post")
        div.row
          - if(!u.isDefined)
            div.input-field.col.s12
              input(type="text" name="loginId" value="#{u.map(_.loginId)}" length="120")
              label ID
          - if(u.isDefined)
            div.input-field.col.s12
              input(type="text" value="#{u.map(_.loginId)}" readonly="true")
              label ID
        div.row
          div.input-field.col.s12
            input(type="text" name="name" value="#{u.map(_.name)}" length="120")
            label Name
        div.row
          div.input-field.col.s12
            input(type="text" name="email" value="#{u.map(_.email)}" length="120")
            label Mail
        div.row
          div.input-field.col.s12
            input(type="text" name="password" length="120")
            label Pass
        div.row
          div.input-field.col.s12
            input.filled-in#filled-in-box{
              :type=>"checkbox",
              :name=>"root",
              :checked=>{u.map(_.root).getOrElse(false)},
              :disabled=>{!(u.map(u => SessionHolder.root && !u.self ).getOrElse(false))} }
            label(for="filled-in-box") 管理者  
        textarea#base64(style="display: none;")
    button.waves-effect.waves-light.btn(type="submit")
      i.material-icons.right check
      |保存
  div#modal1.modal.modal-fixed-footer
    div.modal-content
      h4 Modal Header
      div(style="text-align: center; height: 100%;")
        canvas#uploaded
        canvas#resized(width="200" height="200" style="display: none;")
    div.modal-footer
      a.modal-action.modal-close.waves-effect.waves-green.btn-flat(href="#!") キャンセル
      a.modal-action.modal-close.waves-effect.waves-green.btn-flat(href="#!") 決定
:!javascript
  $(document).ready(function(){
    var cancelSelection;
    
    $('#modal1').bind('drop', function(e){
      e.preventDefault();
      var files = e.originalEvent.dataTransfer.files;
      loadFile(files[0], function() {
        var uploaded = document.getElementById('uploaded');
        uploaded.width = this.width;
        uploaded.height = this.height;
        uploaded.getContext('2d').drawImage(this, 0, 0);
        var imgSelect = $(uploaded).imgAreaSelect({
          handles: true,
          onSelectEnd: selectEnd,
          aspectRatio: "1:1"
        });
        cancelSelection = function(){ imgSelect.cancelSelection(); };
      });
    }).bind('dragenter dragover', function(){
      return false;
    });
    
    $('#modal-trigger').leanModal({
      complete: cancelSelection
    });
    
    $('body').bind('drop dragenter dragover', function(e){
      return false;
    });
    
  });
  
  function selectEnd(img, selection){
    if (!selection.width || !selection.height)
        return;
    
    var uploaded = document.getElementById('uploaded');
    var resized   = document.getElementById('resized');

    var sourceX = selection.x1;
    var sourceY = selection.y1;
    var sourceW = selection.width;
    var sourceH = selection.height;
    
    var srcData = uploaded.getContext('2d').getImageData(sourceX, sourceY, sourceW, sourceH).data;
    var imageDataTo = resized.getContext('2d').createImageData(200, 200);
    
    pica.resizeBuffer({
        src     : srcData,
        dest    : imageDataTo.data,
        width   : sourceW,
        height  : sourceH,
        toWidth : 200,
        toHeight: 200,
        quality : 3
      },
      function() {
        resized.getContext('2d').putImageData(imageDataTo, 0, 0);
        
        var data = resized.toDataURL('image/png');
        document.getElementById('base64').value = data;
        document.getElementById('image').src = data;
    }); 
  }
  